<!doctype html><html lang="zh-tw">
<head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="iThome 網站首載：遲到的Optional？
      
      在Apple發佈的Swift語言中，有些變數的型態名稱之後會加上問號（像是Int?），乍看很新奇，引發了不少討論，實際上...">

<meta property="og:locale" content="zh_TW">
<meta property="og:title" content="遲到的Optional？">
<meta property="og:type" content="article">
<meta property="og:url" content="https://openhome.cc/Gossip/Programmer/Optional.html">
<meta property="og:image" content="https://openhome.cc/Gossip/images/caterpillar_small.jpg">
<meta property="og:site_name" content="OPENHOME.CC">
<meta property="og:description" content="iThome 網站首載：遲到的Optional？
      
      在Apple發佈的Swift語言中，有些變數的型態名稱之後會加上問號（像是Int?），乍看很新奇，引發了不少討論，實際上...">


    <title>遲到的Optional？</title>

<link rel="stylesheet" href="http://openhome.cc/Gossip/css/pure-0.6.0/pure-min.css">

    <!--[if lte IE 8]>
        <link rel="stylesheet" href="../css/layouts/side-menu-old-ie.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="http://openhome.cc/Gossip/css/layouts/side-menu.css">
    <!--<![endif]-->
  

     <link rel="stylesheet" href="http://openhome.cc/Gossip/css/caterpillar.css">
     <script async src="http://openhome.cc/Gossip/google-code-prettify/run_prettify.js"></script>
<!-- 網頁層級廣告 --><script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle =window.adsbygoogle || []).push({google_ad_client: "ca-pub-9750319131714390",enable_page_level_ads: true });</script></head>
<body>

<div id="layout">
    <!-- Menu toggle -->
    <a href="Optional.html#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon --><span></span>
        
    </a>
    <div id="menu">
        <div class="pure-menu">
            <a class="pure-menu-heading" href="http://openhome.cc/Gossip/Programmer/">回程式人目錄</a>
            <ul class="pure-menu-list">
                <br><div class="social" style="text-align: center;"><a href="http://twitter.com/caterpillar"><img title="Twitter" alt="Twitter" src="../images/twitter.png"></a> <a href="http://www.facebook.com/openhome.cc"><img title="Facebook" alt="Facebook" src="../images/facebook.png"></a> </div><br><div id="search box"><script>(function() {var cx = 'partner-pub-9750319131714390:3926766884';var gcse = document.createElement('script');gcse.type = 'text/javascript';gcse.async = true;gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(gcse, s);})();</script><gcse:searchbox-only></gcse:searchbox-only></div><br><div class="ad" style="text-align: center;"><script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 2015 新版型 160 x 600 廣告 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-9750319131714390"
     data-ad-slot="3747048883"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div></li>
            </ul>
        </div>
    </div>

    <main id="main">
        <header class="header">
            <h1>遲到的Optional？</h1>
        </header>

        <article class="content"><br><div class="ad-3" style="text-align: center;"><script async="" src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- 2015 新版型回應式廣告 --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9750319131714390" data-ad-slot="7104125683" data-ad-format="auto"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div> 
             iThome 網站首載：<a href="http://www.ithome.com.tw/voice/91013">遲到的Optional？</a><br>
      <br>
      在Apple發佈的Swift語言中，有些變數的型態名稱之後會加上問號（像是<code>Int?</code>），乍看很新奇，引發了不少討論，實際上這是個<code>Optional</code>型態，JDK8的Lambda專案中，API不少都會搭配<code>Optional</code>，隨著越來越多人開始評估JDK8，也有了越來越多對<code>Optional</code>的討論，實際上<code>Optional</code>不是新的東西，然而，對Java這門語言來說，或許是個遲到的東西。<br>
      <br>
      <dl>
        <dt>可有可無的Optional</dt>
      </dl>
      <br>
      對於一開始就內建<code>Optional</code>語法支援或API的語言來說，像是Swift，由於<code>Optional</code>的影子隨時隨地都會出現（也因此成了Swift中討論的熱點特性），提醒了開發者必須處理可能出現或不出現值的狀況，這類語言使用接受<code>Optional</code>的程度就較高，也較少有null引發的相關問題，像是Scala一開始就有<code>Option</code>，因而較少會面對<code>NullPointerException</code>的問題。<br>
      <br>
      實際上，在JDK8出現前，就有程式庫提供<code>Optional</code>，像是guava-libraries，或許因為並非Java標準化API，因而不被重視，JDK8對<code>Optional</code>做了標準化，因而也就引來了一些爭論：該在會出現<code>null</code>可能性的場合，全面使用<code>Optional</code>取代嗎？實際上，對既有的程式來說，這樣的改動在API規格上更動太大，與Java一些使用慣例也有可能產生衝突問題，像是Getter慣例，因而全面採用不切實際。<br>
      <br>
      對JDK8來說，<code>Optional</code>一開始的設計，也不是用來取代所有可能出現<code>null</code>或引發<code>NullPointerException</code>的場合，在〈Shouldn't Optional be Serializable?〉這篇討論中，Brian Goetz解釋了為什麼<code>Optional</code>不是<code>Serializable</code>，因為當初的設計是應當只將<code>Optional</code>用在傳回值時使用，甚至一度想將之命名為<code>OptionalReturn</code>，目的是從名稱上強調、表示出它的意圖與使用場合。顯然地，<code>Optional</code>不適合當作值域（Field），因為它不是<code>Serializable</code>，開發者也沒辦法禁止Java的變數指向<code>null</code>，因而想用<code>Optional</code>來全面避免<code>NullPointerException</code>也是不可能的事。<br>
      <br>
      <dl>
        <dt>選擇性地使用Optional</dt>
      </dl>
      <br>
      在選擇是否使用<code>Optional</code>上，經常被討論的就是參數上該使用<code>Optional</code>嗎？這方面爭議最大，因為方法呼叫上並不方便，畢竟使用者得特別將值包裝為<code>Optional</code>才能作為引數，即使在Scala中一開始就內建了<code>Option</code>，是否在參數上使用<code>Option</code>也一直是有爭議；另一方面，某些參數可有可無的目的，通常是在參數值從缺時提供預設值，這在Java中可以用Overloading來解決，也可以避免在方法中使用不必要的防禦式設計來檢查傳入值為<code>null</code>的情況，必要時也可搭配FindBugs的<code>@DefaultAnnotation(NonNull.class)</code>或<code>@NonNull</code>來做靜態檢查。<br>
      <br>
      在方法中使用<code>Optional.ofNullable</code>來取代那些原本會檢查<code>null</code>的程式碼，比較不會有爭議，通常有也只是閱讀習慣的問題，畢竟終究是會導致一點風格轉變，這部份不否認地，程式碼相關維護人員都得學習與習慣<code>Optional</code>的使用，大家才能從風格轉變上得到好處，用<code>map</code>或<code>flatMap</code>來取代連續的<code>null</code>判斷也會是後續的好處，要瞭解、熟悉與閱讀這兩個方法的運用，並不會花太多時間。<br>
      <br>
      將<code>Optional</code>作為傳回值，一般是比較建議的，JDK8上<code>Optional</code>的設計原本也是為此，傳回值型態上，如果開發者想要明確提示API客戶端，必須檢查結果可能是空的情況時，可能就是使用<code>Optional</code>的時機，搭配有方法提示功能的編譯器時，更能突顯益處。不過，並非所有結果為空的情況，都要改為<code>Optional</code>，像是對於那些本身有定義「空」或「無值」的API，像是<code>Collection</code>，這些API在沒有結果時，應該傳回本身定義的「空」，例如<code>Collections.emptyList()</code>，這也可避免傳回值宣告為<code>Optional&lt;Collection&lt;String&gt;&gt;</code>而不易閱讀與使用。<br>
      <br>
      <dl>
        <dt>Null Object Pattern</dt>
      </dl>
      <br>
      在避免<code>NullPointerException</code>上，其實尚有其他方式可以避免，像是採用Null Object Pattern，這個模式可以在小幅更動API的情況下，避免<code>NullPointerException</code>且讓程式碼變得簡潔，具體來說，就是為某型態建立一個子類別，例如為<code>Customer</code>建立一個<code>NullCustomer</code>子類別，實現檢查出<code>null</code>時的一些預設行為，然後用<code>NullCustomer</code>實例取代那些原本傳入<code>null</code>的場合，並去除掉那些<code>null</code>檢查，使得程式碼簡潔，<code>NullCustomer</code>實例可以設計為單例（Singleton），以像是<code>Customer.NullCustomer</code>或<code>Customer.nullCustomer()</code>的方式提供。<br>
      <br>
      實際上，這就是在後續為事前沒有定義「空」或「無值」的API進行補救定義，將原本空或無值時該有的特定行為封裝到特定的Null Object中，有趣的是，Null Object發展出幾個特定的模式，例如，Groovy中如果撰寫p.job?.salary，p或job或salary其中之一是null，最後都會得到null的結果，而不是得到NullPointerException，這稱為Safe Navigation Operator。<br>
      <br>
      Groovy中還有個Elvis Operator，不同於Java只將<code>?:</code>作為三元運算子（Ternary operator），Groovy中的<code>?:</code>可以是二元運算子（Binary operator），舉例來說，<code>user.name ?: "Anonymous"</code>如果<code>user.name</code>不為<code>null</code>，就會傳回<code>user.name</code>的值，否則傳回<code>"Anonymous"</code>，相對於<code>user.name ? user.name : "Anonymous"</code>來說簡潔許多。儘管沒有語法上的直接支援，JDK8中的<code>Optional</code>，算是在API層次上支援了Elvis Operator或Safe Navigation Operator，例如，Groovy中<code>user.name ?: "Anonymous"</code>，使用<code>Optional</code>就會是<code>userOptional.orElse("Anonymous")</code>，Groovy中<code>p.job?.salary</code>，JDK8中也可以用<code>Optional</code>的<code>map</code>來達到類似需求。<br>
      <br>
      <dl>
        <dt>遲到的是處理不存在時的共識</dt>
      </dl>
      <br>
      <code>Optional</code>不是新的東西，處理的問題也不是沒有過解決方案，只是始終未受重視，某些程度上，Swift中將<code>Optional</code>處理內建為語法，或者是JDK8中對<code>Optional</code>的標準化，起到了像設計模式這東西的作用，能在思考如何處理有無值這類議題時，有個共同的思考起點，喚起大家對這類議題的重視，從而討論出大家共同的基礎或共識，並能有共通的詞彙，而不是自我想像，沒有規範下，各自使用各自的想法來解決這類問題。<br>
      <br>
      實際上，除了明確定義「空」或「無」、值不存在時流程上該如何處理之外，還有更多的情況，像是結果不存在是錯誤還是空無，不存在這個問題，遠比我們想像地還要複雜，ingramchen在〈Java 8 Optional, Revisited〉最後就打趣的說，相對於這類要討論的情況「Monad真是簡單多了」。<br>
      <br>
      <code>Optional</code>在Java中的標準化算是遲到了，不過或許遲到的並不是<code>Optional</code>，而是處理不存在時的共識，<code>Optional</code>只是提醒了我們，過去對這類問題忽視的程度有多麼嚴重，若從今以後還不加以重視，即使用了<code>Optional</code>，也仍不可能避免<code>NullPointerException</code>，畢竟，開發者還是可以在宣告<code>Optional</code>的地方持續漫不經心，繼續傳遞<code>null</code>。<br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul><br><br><div class="ad336-280" style="text-align: center;"><script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- 2015 新版型廣告 336 x 280 --><ins class="adsbygoogle" style="display:inline-block;width:336px;height:280px" data-ad-client="ca-pub-9750319131714390" data-ad-slot="9976409681"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div><br><div class="recommend" style="text-align: center;"><hr><script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- 自動大小回應相符內容 --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9750319131714390" data-ad-slot="4953478487" data-ad-format="autorelaxed"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></article></main></div></body>
<script src="http://openhome.cc/Gossip/js/ui.js"></script>
</html>
<div class="analytics"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QVQQYFSC8J"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-QVQQYFSC8J');</script></div>
